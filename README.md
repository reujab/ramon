# Ramon

> :warning: This project is a WIP and not yet functional. All configuration is subject to change.

Ramon is a lightweight server monitoring framework. It runs actions (e.g. sending emails) when certain conditions are met. For example, you can configure Ramon to send an email every time an SSH connection from a new IP address is established. Or send an email when a service goes down. Perhaps you would like daily emails of any 5xx status codes that occurred. Ramon makes this easy.

Ramon's design is heavily inspired by [fail2ban](https://github.com/fail2ban/fail2ban) and [Tasker](https://play.google.com/store/apps/details?id=net.dinglisch.android.taskerm).

## Examples

### Setup

```toml
[notify.default]
smtp = "localhost:587"
from = "ramon@{{host}}"
to = "you@{{host}}"
limit = "10/m"
# When a notification is dispatched, wait 10 seconds to see
# if another action of the same type occurs, and aggregate
# them into one notification. If this process repeats for
# longer than 1 minute, send the notification immediately.
aggregate = "10s"
aggregate_timeout = "1m"
notify = "default"

# Aggregate all info notifications, and send them all in
# one email at 8:00AM daily.
[notify.type.info]
aggregate = "* * * 8:00AM"

# Do not aggregate critical notifications.
[notify.type.critical]
aggregate = "0s"
```

### SSH

```toml
# Log each login from a new IP
[var]
ssh_ips = { length = 64, store = true }

[monitor.ssh_login]
service = "ssh"
match_log = '^.*\]: Accepted \S+ for (?<user>\S+) from (?<ip>)'
if = { "!ssh_ips" = "{{ip}}" }
push = { ssh_ips = "{{ip}}" }
notify = { type = "critical", title = "New SSH login from {{ip}} to {{user}}@{{host}}" }

# Alternatively, log every login
[monitor.ssh_login]
service = "ssh"
match_log = '^.*\]: Accepted \S+ for (?<user>\S+) from (?<ip>)'
[[monitor.ssh_login.actions]]
if = { ssh_ips = "{{ip}}" }
# We only send these info emails once per day.
notify = { type = "info", title = "SSH login to {{user}}@{{host}}" }
[[monitor.ssh_login.actions]]
if = { "!ssh_ips" = "{{ip}}" }
push = { ssh_ips = "{{ip}}" }
notify = { type = "critical", title = "New SSH login from {{ip}} to {{user}}@{{host}}" }
```

### System resources

```toml
[monitor.cpu]
cpu = ">90"
threshold = "2m"
notify = { type = "warn", title = "[{{host}}] CPU > 90% for 2m" }
cooldown = "1h"

[monitor.ram]
ram = ">90"
swap = ">50"
notify = { type = "warn", title = "[{{host}}] RAM: {{ram}}, swap: {{swap}}" }
cooldown = "1h"
```

### Nginx

```toml
[var]
nginx_log = "/var/log/nginx/access.log"

[monitor.nginx_5xx]
log = "{{nginx_log}}"
match_log = '^\S+ \S+ \S+ \[.+\] "(?<path>.*)" (?<code>5\d{2})'
notify = { type = "error", title = "Server error: {{code}} at {{path}}" }

# Report 404s generated by browsers.
# We can determine browsers by seeing if
# they successfully GET a .css file.
[var]
humans = { length = 64 }

[monitor.mark_human]
log = "{{nginx_log}}"
match_log = '^(?<ip>\S+) \S+ \S+ \[.+\] ".*\.css" 200'
push = { human_ips = "{{ip}}" }

[monitor.nginx_404]
log = "{{nginx_log}}"
match_log = '^(?<ip>\S+) \S+ \S+ \[.+\] "(?<path>.*)" 404'
if = { human_ips = "{{ip}}" }
notify = { type = "info", title = "404 at {{path}}" }
```

### HTTP

```toml
[monitor.example_endpoint]
every = "5m"
get = "https://example.com/endpoint"
if = { "!err" = "" }
notify = { type = "error", title = "{{url}}: {{err}}" }
```

### systemd

```toml
[monitor.services]
on = [ "service_fail" ]
notify = { type = "error", title = "Service failed: {{service}}" }

[monitor.critical_service]
service = "criticald"
on = [ "service_fail" ]
notify = { type = "critical", title = "Critical service failed! Restarting..." }
```

### System integrity

```toml
[monitor.etc_passwd]
watch = "/etc/passwd"
notify = { type = "critical", title = "File changed: /etc/passwd" }

[monitor.ports]
on = [ "port_open" ]
notify = { type = "critical", title = "New port opened: {{port}}" }
```

### Functions

```toml
# The following three monitors function identically.

[monitor.1]
# ...
exec = 'echo "Cpu: $cpu%"'

[monitor.2]
# ...
exec = ["echo", "Cpu:", "{{cpu}}%"]

[function.print_cpu]
exec = ["echo", "Cpu:", "{{cpu}}%"]
[monitor.3]
# ...
call = "print_cpu"
```

## Specification (WIP)

On startup, Ramon loads [an internal config file] with sane defaults, and then it loads /etc/ramon.d/\*.toml, and finally it loads /etc/ramon.toml. Each succeeding config file overwrites any properties loaded prior.

### `[function]`\*

This table defines various functions that can be referenced by monitors. See [Functions](#functions).

### `[function.<name>]`\*

This table defines a function that runs actions.

#### `function.<name>.call`\*

This key may be either a String or an Array. If this key is a String, the function with this name will be called. If this key is an Array, each function will be called synchronously.

#### `function.<name>.exec`

This key may be either a String or an Array. If this key is a String, it is called as a single argument to `sh -c` (\*nix) or `cmd /C` (Windows). If this key is an Array, the first element is the binary, and the remaining elements are passed as arguments.

### `[function.<name>.notify]`\*

This table defines a notification that will be dispatched when the function is called.

#### `function.<name>.notify.type`\*

This String defines the notification's type. Its default value is `info`.

### `[function.<name>.push]`\*

This table pushes values to each array.

#### Example

This table sets each key to its value.

```toml
[var]
arr = { length = 8 }

[function.foo]
push = { arr = 42 }
```

### `[function.<name>.set]`\*

#### Example

```toml
[function.foo]
set = { a = 42, b = "Hello, world" }
```

### `[monitor]`

Each monitor has three different types of keys:

- metadata
- conditions
- actions

### `[monitor.<name>]`

This table defines a monitor.

#### `monitor.<name>.log` (metadata)

This String specifies the log file for the monitor. Mutually exclusive with `service`.

#### `monitor.<name>.service`\* (metadata)

This String specifies the journal to use for the monitor. Mutually exclusive with `log`.

#### `monitor.<name>.every` (condition)

This condition is true each interval.

##### Example

```toml
[monitor.1]
every = "1m"
notify = { title = 'The current time is {{ exec("date") }}.' }
```

#### `monitor.<name>.match_log` (condition)

This condition requires each new line of the log file to match the specified regular expression to be true. This key can either be a regular expression or an array of regular expressions, where each regex must match.\*

#### `monitor.<name>.ignore_log` (condition)

This condition requires each new line of the log file to _not_ match the specified regular expression to be true. This key can either be a regular expression or an array of regular expressions, where each regex must not match.\*

#### `monitor.<name>.threshold`\* (condition)

This condition requires every other condition to be true `n` times within `d` duration before running the actions. The format of this key is either `"n/d"` or `"d"`. For the latter, the other conditions must be true for 100% of the duration before running the actions.

##### Example

```toml
[monitor.server_errors]
log = "/var/log/server/error.log"
threshold = "3/1m"
notify = { title = "Three server errors occured within one minute!" }
```

#### `monitor.<name>.cooldown`\* (condition)

This condition is false for `d` duration after an action is run and true afterward.

##### Example

```toml
[monitor.1]
every = "1s"
exec = "echo I will never run more than once per minute."
cooldown = "1m"
```

#### `monitor.<name>.if`\* (condition)

This condition allows you to compare different values.

- Comparing strings: `if = { str = "str" }`
- Comparing string to var: `if = { str = "{{var}}" }`
- Comparing numbers: `if = { num = 42 }` or `if = { num = "42" }`
- Comparing number to var: `if = { num = "{{var}}" }`
- Greater/less than: `if = { num = ">90" }` or `if = { num = "<{{var}}" }`
- Array contains value: `if = { arr = "{{var}}" }`
- Array does not contain value: `if = { "!arr" = "{{var}}" }`

##### Example (and)

```toml
[monitor.if_and]
# ...
if = { a = 42, b = "Hello world" }
notify = { title = "a = 42 AND b = 'Hello world'" }
```

##### Example (or)

```toml
[monitor.if_or]
# ...
if = [{ a = 42 }, { b = "Hello world" }]
notify = { title = "a = 42 OR b = 'Hello world'" }
```

##### Example (or alternate)

```toml
[function.if_or]
notify = { title = "a = 42 OR b = 'Hello world'" }

[monitor.if_or]
# ...
[[monitor.if_or.actions]]
if = { a = 42, "!b" = "Hello world" }
call = "if_or"
[[monitor.if_or.actions]]
if = { "!a" = 42, b = "Hello world" }
call = "if_or"
```

#### `monitor.<name>.cpu`\* (condition)

#### `monitor.<name>.ram`\* (condition)

#### `monitor.<name>.swap`\* (condition)

#### `monitor.<name>.<action>` (action)

The monitor can contain any action. See [[function.\<name\>]](#functionname) for a list of actions.

### `[notify]`\*

Notification settings (TODO).

### `[var]`\*

Variable settings (TODO).

\* Not yet implemented
